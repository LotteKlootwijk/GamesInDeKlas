<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill-Tree Leerplatform</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
      }
      .tree-connector {
        pointer-events: none;
        z-index: 0;
      }
      @keyframes pulse-gold {
        0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
        100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
      }
      .pulse-active {
        animation: pulse-gold 2s infinite;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo } = React;

      // --- CONSTANTEN ---
      const INITIAL_GAMES_CONFIG = {
        1: { id: 1, name: 'Introductie', unlocks: [2], minScore: 50, row: 0, col: 0 },
        2: { id: 2, name: 'Basis Vaardigheden', unlocks: [3, 6], minScore: 60, row: 1, col: 0 },
        3: { id: 3, name: 'Logica A', unlocks: [4], minScore: 70, row: 2, col: -1 },
        4: { id: 4, name: 'Logica B', unlocks: [5], minScore: 65, row: 3, col: -1 },
        5: { id: 5, name: 'Gevorderde Logica', unlocks: [9], minScore: 80, row: 4, col: -1 },
        6: { id: 6, name: 'Creativiteit A', unlocks: [7], minScore: 55, row: 2, col: 1 },
        7: { id: 7, name: 'Creativiteit B', unlocks: [8], minScore: 75, row: 3, col: 1 },
        8: { id: 8, name: 'Gevorderde Creatie', unlocks: [9], minScore: 70, row: 4, col: 1 },
        9: { id: 9, name: 'Eindbaas Spel', unlocks: [], minScore: 90, row: 5, col: 0 }
      };

      const CONNECTIONS = [
        { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 2, to: 6 },
        { from: 3, to: 4 }, { from: 4, to: 5 }, { from: 6, to: 7 },
        { from: 7, to: 8 }, { from: 5, to: 9 }, { from: 8, to: 9 }
      ];

      const KEYS = {
        TEACHER_PWD: 'skill_tree_teacher_pwd',
        ALL_STUDENTS: 'skill_tree_all_students',
        GAMES_CONFIG: 'skill_tree_games_config'
      };

      // --- COMPONENTEN ---

      const SkillNode = ({ game, status, position, onClick }) => {
        const isUnlocked = status.unlocked;
        const isCompleted = status.completed;
        const isPulsing = isUnlocked && !isCompleted;

        return (
          <div 
            className={`absolute w-20 h-20 rounded-full flex flex-col items-center justify-center cursor-pointer transition-all duration-300 z-10 
              ${isUnlocked ? 'scale-100 hover:scale-110 active:scale-95 shadow-xl' : 'scale-90 opacity-40 cursor-not-allowed grayscale'}
              ${isCompleted ? 'bg-gradient-to-br from-emerald-400 to-emerald-600 border-4 border-white' : 
                isUnlocked ? 'bg-white border-4 border-indigo-500' : 'bg-gray-200 border-4 border-gray-300'}
              ${isPulsing ? 'pulse-active' : ''}
            `}
            style={{ left: position.x, top: position.y }}
            onClick={isUnlocked ? onClick : undefined}
          >
            {!isUnlocked ? (
              <span className="text-gray-400 text-2xl">ðŸ”’</span>
            ) : (
              <>
                {isCompleted && (
                  <div className="absolute -top-1 -right-1 bg-white rounded-full p-1 shadow-sm">
                    <svg className="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" />
                    </svg>
                  </div>
                )}
                <span className={`font-black text-2xl ${isCompleted ? 'text-white' : 'text-indigo-600'}`}>{game.id}</span>
                {status.score !== undefined && (
                  <div className="absolute -bottom-2 bg-amber-400 text-white text-[10px] font-black px-2 py-0.5 rounded-full border-2 border-white shadow-sm">
                    {status.score}
                  </div>
                )}
              </>
            )}
            <div className={`absolute -bottom-10 whitespace-nowrap text-[10px] font-black uppercase tracking-tighter w-40 text-center transition-colors ${
              isCompleted ? 'text-emerald-600' : isUnlocked ? 'text-indigo-600' : 'text-gray-400'
            }`}>
              {game.name}
            </div>
          </div>
        );
      };

      const GameModal = ({ game, onClose, onManualScore }) => {
        const [manualScore, setManualScore] = useState('');
        const [loading, setLoading] = useState(true);

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
            <div className="bg-white rounded-3xl w-full max-w-6xl max-h-[95vh] flex flex-col overflow-hidden shadow-2xl">
              <div className="p-6 border-b flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <div className="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold">{game.id}</div>
                  <div>
                    <h2 className="text-2xl font-black text-gray-800 uppercase tracking-tight">{game.name}</h2>
                    <p className="text-xs text-indigo-500 font-bold">MINIMALE SCORE: {game.minScore}</p>
                  </div>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-all hover:rotate-90">
                  <svg className="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M6 18L18 6M6 6l12 12" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                  </svg>
                </button>
              </div>

              <div className="flex-1 bg-gray-900 relative">
                {loading && <div className="absolute inset-0 flex items-center justify-center text-white bg-gray-900 z-10"><p className="animate-pulse">SPEL LADEN...</p></div>}
                <iframe 
                  src={`games/spel${game.id}.html`} 
                  className="w-full h-full border-none" 
                  onLoad={() => setLoading(false)}
                />
              </div>

              <div className="p-4 bg-gray-50 border-t flex flex-col sm:row items-center justify-between gap-4">
                <p className="text-[10px] text-gray-500 max-w-sm">
                  De score wordt automatisch verzonden bij het einde van het spel. Werkt het niet? Voer je score dan hieronder handmatig in.
                </p>
                <div className="flex items-center gap-3 bg-white p-2 pl-4 rounded-2xl border shadow-sm">
                  <input 
                    type="number" 
                    placeholder="Punten" 
                    className="w-20 px-3 py-2 border rounded-xl font-bold text-center outline-none focus:ring-2 focus:ring-indigo-300" 
                    value={manualScore} 
                    onChange={e => setManualScore(e.target.value)} 
                  />
                  <button 
                    className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-black hover:bg-indigo-700 transition-all active:scale-95"
                    onClick={() => manualScore && onManualScore(parseInt(manualScore))}
                  >
                    OPSLAAN
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const TeacherDashboard = ({ onLogout, gamesConfig, onUpdateConfig }) => {
        const [tab, setTab] = useState('students');
        const [students, setStudents] = useState([]);
        const [filter, setFilter] = useState('');

        useEffect(() => {
          const raw = localStorage.getItem(KEYS.ALL_STUDENTS);
          if (raw) setStudents(JSON.parse(raw));
        }, []);

        const classes = Array.from(new Set(students.map(s => s.class)));
        const filtered = filter ? students.filter(s => s.class === filter) : students;

        return (
          <div className="bg-white rounded-3xl shadow-xl overflow-hidden max-w-6xl mx-auto">
            <div className="bg-indigo-600 p-8 text-white flex justify-between items-center">
              <div>
                <h1 className="text-3xl font-black uppercase italic tracking-tighter">Docenten Paneel</h1>
                <p className="opacity-80 font-medium">Volg resultaten en beheer levels</p>
              </div>
              <button onClick={onLogout} className="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-2xl font-bold transition-all">UITLOGGEN</button>
            </div>

            <div className="flex border-b bg-gray-50">
              <button onClick={() => setTab('students')} className={`flex-1 py-4 font-black uppercase tracking-widest text-sm ${tab === 'students' ? 'text-indigo-600 bg-white border-b-4 border-indigo-600' : 'text-gray-400'}`}>LEERLINGEN</button>
              <button onClick={() => setTab('settings')} className={`flex-1 py-4 font-black uppercase tracking-widest text-sm ${tab === 'settings' ? 'text-indigo-600 bg-white border-b-4 border-indigo-600' : 'text-gray-400'}`}>INSTELLINGEN</button>
            </div>

            <div className="p-8">
              {tab === 'students' ? (
                <div className="space-y-6">
                  <div className="flex items-center gap-4">
                    <span className="font-bold text-gray-500">FILTER OP KLAS:</span>
                    <select className="px-4 py-2 border rounded-xl font-bold text-indigo-600 outline-none" value={filter} onChange={e => setFilter(e.target.value)}>
                      <option value="">ALLE KLASSEN</option>
                      {classes.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                  <div className="overflow-x-auto rounded-2xl border">
                    <table className="w-full text-left">
                      <thead className="bg-gray-50 border-b">
                        <tr>
                          <th className="p-4 font-black text-gray-400 text-xs">NAAM</th>
                          <th className="p-4 font-black text-gray-400 text-xs">KLAS</th>
                          <th className="p-4 font-black text-gray-400 text-xs">LEVELS</th>
                          <th className="p-4 font-black text-gray-400 text-xs">SCORE GEM.</th>
                          <th className="p-4 font-black text-gray-400 text-xs">ACTIEF</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filtered.map(s => {
                          const prog = Object.values(s.progress);
                          const comp = prog.filter(p => p.completed).length;
                          const scores = prog.map(p => p.score).filter(sc => sc != null);
                          const avg = scores.length ? (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(1) : '0';
                          return (
                            <tr key={s.id} className="border-b hover:bg-gray-50">
                              <td className="p-4 font-bold text-gray-800">{s.name}</td>
                              <td className="p-4 text-gray-500 font-medium">{s.class}</td>
                              <td className="p-4 font-bold text-emerald-600">{comp} / 9</td>
                              <td className="p-4 font-mono font-bold text-indigo-600">{avg}</td>
                              <td className="p-4 text-xs text-gray-400">{new Date(s.lastActive).toLocaleDateString()}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {Object.values(gamesConfig).map(g => (
                    <div key={g.id} className="p-4 bg-gray-50 rounded-2xl border flex items-center justify-between">
                      <span className="font-bold text-gray-700">SPEL {g.id}: {g.name}</span>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-gray-400">MIN. SCORE:</span>
                        <input 
                          type="number" 
                          className="w-16 px-2 py-1 border rounded-lg text-center font-bold" 
                          value={g.minScore} 
                          onChange={e => onUpdateConfig({...gamesConfig, [g.id]: {...g, minScore: parseInt(e.target.value)}})}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };

      // --- HOOFD APP ---

      const App = () => {
        const [auth, setAuth] = useState({ role: null, userData: null });
        const [gamesConfig, setGamesConfig] = useState(INITIAL_GAMES_CONFIG);
        const [activeGameId, setActiveGameId] = useState(null);
        const [notif, setNotif] = useState(null);

        // Load persisted config
        useEffect(() => {
          const saved = localStorage.getItem(KEYS.GAMES_CONFIG);
          if (saved) setGamesConfig(JSON.parse(saved));
        }, []);

        const showNotif = (message, type = 'success') => {
          setNotif({ message, type });
          setTimeout(() => setNotif(null), 4000);
        };

        const updateStudentData = useCallback((updated) => {
          setAuth(prev => ({ ...prev, userData: updated }));
          localStorage.setItem(`student_${updated.id}`, JSON.stringify(updated));
          
          const raw = localStorage.getItem(KEYS.ALL_STUDENTS);
          let all = raw ? JSON.parse(raw) : [];
          const idx = all.findIndex(s => s.id === updated.id);
          if (idx > -1) all[idx] = updated; else all.push(updated);
          localStorage.setItem(KEYS.ALL_STUDENTS, JSON.stringify(all));
        }, []);

        const handleScore = (gameId, score) => {
          if (!auth.userData) return;
          const config = gamesConfig[gameId];
          const newProg = { ...auth.userData.progress };
          const isComp = score >= config.minScore;

          newProg[gameId] = {
            ...newProg[gameId],
            score: Math.max(score, newProg[gameId]?.score || 0),
            completed: newProg[gameId]?.completed || isComp,
            unlocked: true
          };

          if (isComp) {
            config.unlocks.forEach(uid => {
              if (uid === 9) {
                if (newProg[5]?.completed && newProg[8]?.completed) newProg[9] = { ...newProg[9], unlocked: true };
              } else newProg[uid] = { ...newProg[uid], unlocked: true };
            });
            showNotif(`Level behaald met een score van ${score}!`, 'success');
          } else {
            showNotif(`Score ${score} is te laag (min. ${config.minScore}). Probeer opnieuw!`, 'error');
          }

          updateStudentData({ ...auth.userData, progress: newProg, lastActive: new Date().toISOString() });
          setActiveGameId(null);
        };

        useEffect(() => {
          const listener = (e) => {
            const { type, score, gameId } = e.data;
            if (type === 'GAME_SCORE_UPDATE' && auth.userData) {
              handleScore(Number(gameId || activeGameId), Number(score));
            }
          };
          window.addEventListener('message', listener);
          return () => window.removeEventListener('message', listener);
        }, [auth.userData, activeGameId, gamesConfig]);

        if (!auth.role) {
          return (
            <div className="flex items-center justify-center min-h-screen p-4">
              <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-gray-100 transform transition-all hover:scale-[1.01]">
                <h1 className="text-5xl font-black text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-indigo-400 tracking-tighter italic">SKILLTREE</h1>
                <Login 
                  onStudent={(d) => setAuth({ role: 'STUDENT', userData: d })}
                  onTeacher={() => setAuth({ role: 'TEACHER', userData: null })}
                />
              </div>
            </div>
          );
        }

        if (auth.role === 'TEACHER') return <div className="p-8"><TeacherDashboard onLogout={() => setAuth({role:null, userData:null})} gamesConfig={gamesConfig} onUpdateConfig={c => { setGamesConfig(c); localStorage.setItem(KEYS.GAMES_CONFIG, JSON.stringify(c)); }} /></div>;

        return (
          <div className="max-w-7xl mx-auto p-4 md:p-8">
            {notif && (
              <div className={`fixed top-6 right-6 z-[100] px-6 py-4 rounded-2xl shadow-2xl border-2 flex items-center gap-3 animate-bounce transition-all ${
                notif.type === 'success' ? 'bg-emerald-500 text-white border-emerald-300' : 'bg-rose-500 text-white border-rose-300'
              }`}>
                <span className="text-xl font-bold">{notif.type === 'success' ? 'ðŸŒŸ' : 'ðŸ’¡'}</span>
                <span className="font-black uppercase tracking-tight">{notif.message}</span>
              </div>
            )}

            <div className="flex justify-between items-center mb-12 bg-white p-6 rounded-[2rem] shadow-sm border">
              <div className="flex items-center gap-5">
                <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-3xl shadow-lg shadow-indigo-200">ðŸ‘¤</div>
                <div>
                  <h2 className="text-2xl font-black text-gray-800 tracking-tighter italic">HI, {auth.userData.name.toUpperCase()}!</h2>
                  <p className="text-xs font-black text-indigo-500 tracking-widest uppercase">KLAS {auth.userData.class}</p>
                </div>
              </div>
              <button onClick={() => setAuth({role:null, userData:null})} className="px-8 py-3 bg-gray-100 hover:bg-gray-200 text-gray-500 font-black rounded-2xl transition-all active:scale-95 uppercase tracking-widest text-xs">UITLOGGEN</button>
            </div>

            <SkillTree studentData={auth.userData} gamesConfig={gamesConfig} onOpen={setActiveGameId} />
            
            {activeGameId && <GameModal game={gamesConfig[activeGameId]} onClose={() => setActiveGameId(null)} onManualScore={s => handleScore(activeGameId, s)} />}
          </div>
        );
      };

      // --- HULPCOMPONENTEN ---

      const Login = ({ onStudent, onTeacher }) => {
        const [tab, setTab] = useState('student');
        const [name, setName] = useState('');
        const [cls, setCls] = useState('');
        const [pwd, setPwd] = useState('');

        const handleStudent = e => {
          e.preventDefault();
          if (!name || !cls) return alert("Vul alles in!");
          const id = `${name.toLowerCase().replace(/\s/g, '_')}_${cls.toLowerCase()}`;
          const saved = localStorage.getItem(`student_${id}`);
          if (saved) onStudent(JSON.parse(saved));
          else {
            const initial = { id, name, class: cls, progress: { 1: { unlocked: true, completed: false } }, lastActive: new Date().toISOString() };
            localStorage.setItem(`student_${id}`, JSON.stringify(initial));
            const allRaw = localStorage.getItem(KEYS.ALL_STUDENTS);
            const all = allRaw ? JSON.parse(allRaw) : [];
            all.push(initial);
            localStorage.setItem(KEYS.ALL_STUDENTS, JSON.stringify(all));
            onStudent(initial);
          }
        };

        return (
          <div className="space-y-6">
            <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-8">
              <button className={`flex-1 py-3 rounded-xl font-black uppercase text-xs tracking-widest transition-all ${tab === 'student' ? 'bg-white shadow-md text-indigo-600' : 'text-gray-400'}`} onClick={() => setTab('student')}>Leerling</button>
              <button className={`flex-1 py-3 rounded-xl font-black uppercase text-xs tracking-widest transition-all ${tab === 'teacher' ? 'bg-white shadow-md text-indigo-600' : 'text-gray-400'}`} onClick={() => setTab('teacher')}>Docent</button>
            </div>
            {tab === 'student' ? (
              <form onSubmit={handleStudent} className="space-y-4">
                <input type="text" placeholder="JE NAAM" className="w-full px-5 py-4 rounded-2xl border border-gray-200 outline-none focus:ring-4 focus:ring-indigo-100 font-bold tracking-tight" value={name} onChange={e => setName(e.target.value)} />
                <input type="text" placeholder="JE KLAS" className="w-full px-5 py-4 rounded-2xl border border-gray-200 outline-none focus:ring-4 focus:ring-indigo-100 font-bold tracking-tight" value={cls} onChange={e => setCls(e.target.value)} />
                <button type="submit" className="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 transition-all uppercase tracking-widest italic">START AVONTUUR</button>
              </form>
            ) : (
              <form onSubmit={e => { e.preventDefault(); (pwd === (localStorage.getItem(KEYS.TEACHER_PWD) || 'admin123')) ? onTeacher() : alert('Fout!'); }} className="space-y-4">
                <input type="password" placeholder="WACHTWOORD" className="w-full px-5 py-4 rounded-2xl border border-gray-200 outline-none focus:ring-4 focus:ring-indigo-100 font-bold tracking-tight" value={pwd} onChange={e => setPwd(e.target.value)} />
                <button type="submit" className="w-full py-5 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 transition-all uppercase tracking-widest italic">INLOGGEN</button>
              </form>
            )}
          </div>
        );
      };

      const SkillTree = ({ studentData, gamesConfig, onOpen }) => {
        const GRID_X = 230, GRID_Y = 170, OFF_X = 450, OFF_Y = 80;
        const positions = useMemo(() => {
          const p = {};
          Object.values(gamesConfig).forEach(g => p[g.id] = { x: OFF_X + g.col * GRID_X, y: OFF_Y + g.row * GRID_Y });
          return p;
        }, [gamesConfig]);

        const height = (Math.max(...Object.values(gamesConfig).map(g => g.row)) + 1) * GRID_Y + 120;

        return (
          <div className="relative overflow-x-auto pb-20">
            <div className="relative mx-auto" style={{ width: '900px', height: `${height}px` }}>
              <svg className="absolute inset-0 w-full h-full tree-connector">
                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="3" result="blur" /><feComposite in="SourceGraphic" in2="blur" operator="over" /></filter>
                {CONNECTIONS.map((c, i) => {
                  const from = positions[c.from], to = positions[c.to];
                  if (!from || !to) return null;
                  const active = studentData.progress[c.from]?.completed && studentData.progress[c.to]?.unlocked;
                  return (
                    <g key={i}>
                      <line x1={from.x+40} y1={from.y+40} x2={to.x+40} y2={to.y+40} stroke={active ? "#d1fae5" : "#f3f4f6"} strokeWidth="10" strokeLinecap="round" />
                      <line x1={from.x+40} y1={from.y+40} x2={to.x+40} y2={to.y+40} stroke={active ? "#10b981" : "#e5e7eb"} strokeWidth={active ? "4" : "2"} strokeDasharray={active ? "0" : "8,8"} filter={active ? "url(#glow)" : ""} className="transition-all duration-1000" />
                    </g>
                  );
                })}
              </svg>
              {Object.values(gamesConfig).map(g => (
                <SkillNode key={g.id} game={g} status={studentData.progress[g.id] || {unlocked:false}} position={positions[g.id]} onClick={() => onOpen(g.id)} />
              ))}
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
